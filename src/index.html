<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>26 - Code structuring</title>
</head>
<body>
    <canvas class="webgl"></canvas>
    <!-- Fragment shader for protoplanet's position -->
<script id="computeShaderPosition" type="x-shader/x-fragment">
    // 현재 위치 정보를 결정하다

    #define delta ( 1.0 / 60.0 )
    void main() {
        vec2 uv = gl_FragCoord.xy / resolution.xy;
        vec4 tmpPos = texture2D( texturePosition, uv );
        vec3 pos = tmpPos.xyz;
        vec4 tmpVel = texture2D( textureVelocity, uv );
        // vel가 이동하는 방향(다른 아래 compute Shader Velocity 참조)
        vec3 vel = tmpVel.xyz;

        // 이동하는 방향으로 속도를 곱한 수치를 현재 위치에 더한다.
        pos += vel * delta;
    
        gl_FragColor = vec4( pos, 1.0 );
    }
</script>

<!-- Fragment shader for protoplanet's velocity -->
<script id="computeShaderVelocity" type="x-shader/x-fragment">

    // 이동 방향에 대해 여러 가지 계산할 수 있는 셰이더.
    // 이번에는 아무것도 안 했어.
    // 여기서 Vel의 xyz에 대한 정보를 덮어쓰면 그에 따라 이동 방향이 바뀐다.
    
    #include <common>

    void main() {

        vec3 acceleration = vec3( 0.0 );
        vec2 uv = gl_FragCoord.xy / resolution.xy;
        vec4 tmpPos = texture2D( texturePosition, uv );
        vec3 pos = tmpPos.xyz;

        float idParticle = uv.y * resolution.x + uv.x;
        vec4 tmpVel = texture2D( textureVelocity, uv );
        vec3 vel = tmpVel.xyz;
        
       
        gl_FragColor = vec4( vel.xyz, 1.0 );
    }
</script>

<!-- Particles vertex shader -->
<script type="x-shader/x-vertex" id="particleVertexShader">


    #include <common>
    uniform sampler2D texturePosition;
    uniform float cameraConstant;
    uniform float density;
    varying vec4 vColor;
    varying vec2 vUv;
    uniform float radius;



    void main() {
        
        vec4 posTemp = texture2D( texturePosition, uv );
        vec3 pos = posTemp.xyz;
        vColor = vec4( 1.0, 0.7, 1.0, 1.0 );

        // 포인트 사이즈 결정
        vec4 mvPosition = modelViewMatrix * vec4( pos, 1.0 );
        gl_PointSize = 0.5 * cameraConstant / ( - mvPosition.z );

        // uv정보의 인도
        vUv = uv;

        // 변환하여 격납
        gl_Position = projectionMatrix * mvPosition;
    }
</script>

<!-- Particles fragment shader -->
<script type="x-shader/x-fragment" id="particleFragmentShader">
    // VertexShader 로부터 받은 색을 격납할 뿐
    varying vec4 vColor;
    void main() {

        // 둥근 모양으로 색칠하기 위한 계산
        float f = length( gl_PointCoord - vec2( 0.5, 0.5 ) );
        if ( f > 0.1 ) {
            discard;
        }
        gl_FragColor = vColor;
    }
</script>


</body>
</html>